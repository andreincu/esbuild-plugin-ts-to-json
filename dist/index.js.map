{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { BuildOptions, OutputFile, Plugin, PluginBuild } from \"esbuild\";\nimport { mkdir, writeFile } from \"fs/promises\";\nimport path from \"path\";\n\n/**\n * An esbuild plugin to convert TypeScript modules into JSON files.\n *\n * This plugin processes bundled TypeScript files and writes their default\n * exports as JSON. It requires specific esbuild configuration options for compatibility.\n *\n * ### Required esbuild Options:\n * - `write: false` - Prevent writing files directly to disk.\n * - `bundle: true` - Ensure dependencies are resolved.\n * - `format: \"esm\"` - Use ES module output for dynamic imports.\n *\n * ### Example:\n * ```javascript\n * import { build } from \"esbuild\";\n * import { esbuildTsToJson } from \"./esbuild-plugin-ts-to-json\";\n *\n * await build({\n *   entryPoints: [\"src/index.ts\"],\n *   outfile: \"out/bundle.js\",\n *   bundle: true,\n *   write: false,\n *   format: \"esm\",\n *   plugins: [esbuildTsToJson()],\n * });\n * ```\n *\n * @returns {Plugin} The esbuild plugin instance.\n *\n * @throws {Error} If required esbuild options are not set.\n */\nexport function esbuildTsToJson(): Plugin {\n  return {\n    name: \"esbuild-plugin-ts-to-json\",\n    setup(build: PluginBuild) {\n      build.onEnd(async (result) => {\n        validateBuildOptions(build.initialOptions);\n\n        if (!result?.outputFiles?.length) {\n          throw new Error(\"No output files found. Ensure your esbuild config is properly set.\");\n        }\n\n        await Promise.all(result.outputFiles.map(transformFileToJson));\n      });\n    },\n  };\n}\n\nasync function transformFileToJson(file: OutputFile) {\n  const { dir, name } = path.parse(file.path);\n  const outputFilePath = path.resolve(dir, `${name}.json`);\n\n  try {\n    const moduleURI = `data:text/javascript,${encodeURIComponent(file.text)}`;\n    const { default: exportedData = {} } = await import(moduleURI);\n\n    // Serialize the default export to JSON\n    const jsonContent = JSON.stringify(exportedData, null, 2);\n\n    // Write JSON file to disk\n    await mkdir(path.dirname(outputFilePath), { recursive: true });\n    await writeFile(outputFilePath, jsonContent);\n  } catch (error) {\n    console.error(`Failed to process ${file.path}:`, error);\n  }\n}\n\nfunction validateBuildOptions({ write, bundle, format }: BuildOptions) {\n  if (write) {\n    throw new Error(\n      `esbuild config: \"write\" must be set to false. Add \"write: false\" to your config.`\n    );\n  }\n\n  if (!bundle) {\n    throw new Error(\n      `esbuild config: \"bundle\" must be set to true. Add \"bundle: true\" to your config.`\n    );\n  }\n\n  if (format !== \"esm\") {\n    throw new Error(\n      `esbuild config: \"format\" must be set to \"esm\". Add \"format: 'esm'\" to your config.`\n    );\n  }\n}\n"],"mappings":"AACA,OAAS,SAAAA,EAAO,aAAAC,MAAiB,cACjC,OAAOC,MAAU,OAgCV,SAASC,GAA0B,CACxC,MAAO,CACL,KAAM,4BACN,MAAMC,EAAoB,CACxBA,EAAM,MAAM,MAAOC,GAAW,CAtCpC,IAAAC,EAyCQ,GAFAC,EAAqBH,EAAM,cAAc,EAErC,GAACE,EAAAD,GAAA,YAAAA,EAAQ,cAAR,MAAAC,EAAqB,QACxB,MAAM,IAAI,MAAM,oEAAoE,EAGtF,MAAM,QAAQ,IAAID,EAAO,YAAY,IAAIG,CAAmB,CAAC,CAC/D,CAAC,CACH,CACF,CACF,CAEA,eAAeA,EAAoBC,EAAkB,CACnD,GAAM,CAAE,IAAAC,EAAK,KAAAC,CAAK,EAAIT,EAAK,MAAMO,EAAK,IAAI,EACpCG,EAAiBV,EAAK,QAAQQ,EAAK,GAAGC,CAAI,OAAO,EAEvD,GAAI,CACF,IAAME,EAAY,wBAAwB,mBAAmBJ,EAAK,IAAI,CAAC,GACjE,CAAE,QAASK,EAAe,CAAC,CAAE,EAAI,MAAM,OAAOD,GAG9CE,EAAc,KAAK,UAAUD,EAAc,KAAM,CAAC,EAGxD,MAAMd,EAAME,EAAK,QAAQU,CAAc,EAAG,CAAE,UAAW,EAAK,CAAC,EAC7D,MAAMX,EAAUW,EAAgBG,CAAW,CAC7C,OAASC,EAAO,CACd,QAAQ,MAAM,qBAAqBP,EAAK,IAAI,IAAKO,CAAK,CACxD,CACF,CAEA,SAAST,EAAqB,CAAE,MAAAU,EAAO,OAAAC,EAAQ,OAAAC,CAAO,EAAiB,CACrE,GAAIF,EACF,MAAM,IAAI,MACR,kFACF,EAGF,GAAI,CAACC,EACH,MAAM,IAAI,MACR,kFACF,EAGF,GAAIC,IAAW,MACb,MAAM,IAAI,MACR,oFACF,CAEJ","names":["mkdir","writeFile","path","esbuildTsToJson","build","result","_a","validateBuildOptions","transformFileToJson","file","dir","name","outputFilePath","moduleURI","exportedData","jsonContent","error","write","bundle","format"]}